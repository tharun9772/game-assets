<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Discord Login</title>
<style>
  body { font-family: Arial; text-align:center; padding-top:50px; }
  img { border-radius:50%; width:100px; }
</style>
</head>
<body>

<h2>Login with Discord</h2>
<button onclick="discordLogin()">Login</button>

<div id="profile" style="display:none;">
  <img id="avatar">
  <h3 id="name"></h3>
</div>

<script>
const CLIENT_ID = "1437228979667992679";
const REDIRECT = window.location.origin + window.location.pathname;


function setCookie(name, value, days = 1) {
  const d = new Date();
  d.setTime(d.getTime() + (days*24*60*60*1000));
  document.cookie = `${name}=${value};expires=${d.toUTCString()};path=/`;
}

function getCookie(name) {
  return document.cookie.split('; ')
    .find(row => row.startsWith(name + "="))
    ?.split("=")[1];
}

function deleteCookie(name) {
  document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/`;
}

function discordLogin() {
  window.location.href =
    `https://discord.com/oauth2/authorize?client_id=1437228979667992679&response_type=code&redirect_uri=https%3A%2F%2Fmath-hub.pages.dev%2Fbloxcraft-games%2F&scope=guilds.join+identify+email`;
}

async function getUser(token) {
  const response = await fetch("https://discord.com/api/users/@me", {
    headers: { Authorization: `Bearer ${token}` }
  });
  return response.json();
}


if (window.location.search.includes("logout")) {
  deleteCookie("discord_token");
  alert("Logged out!");
  window.location.href = REDIRECT;
}


if (window.location.hash) {
  const params = new URLSearchParams(window.location.hash.substring(1));
  const token = params.get("access_token");

  if (token) {
    setCookie("discord_token", token, 1); 
    history.replaceState(null, "", REDIRECT);
    window.location.reload();
  }
}


const savedToken = getCookie("discord_token");

if (savedToken) {
  getUser(savedToken).then(user => {
    document.getElementById("profile").style.display = "block";
    document.getElementById("name").innerText =
      `${user.username}#${user.discriminator}`;

    const avatar = user.avatar
      ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`
      : `https://cdn.discordapp.com/embed/avatars/${user.discriminator % 5}.png`;

    document.getElementById("avatar").src = avatar;
  }).catch(() => {
    deleteCookie("discord_token"); 
  });
}
</script>

</body>
</html>
